<!-- Step 3: Rank top 3 overall picks -->
<%
  all_pairs = @variants.flat_map(&:title_thumbnail_pairs)
  my_top_pick_ids = @my_top_picks.map(&:title_thumbnail_pair_id)
  top_pick_positions = @my_top_picks.each_with_object({}) { |tp, h| h[tp.title_thumbnail_pair_id] = tp.position }
%>

<div class="mb-6">
  <h1 class="text-xl font-bold text-[#0f0f0f] mb-1">Step 3: Rank your top 3 overall</h1>
  <p class="text-sm text-[#606060]">Forget variants â€” pick your three favorite thumbnails overall. Click in order: first = #1, second = #2, third = #3. Click again to remove.</p>
</div>

<div data-controller="top-picks" data-top-picks-max-value="3">
  <%= form_tag vote_top_picks_path(@video.share_token, @video_share.token), method: :post do %>
    <div data-top-picks-target="hiddenInputs">
      <% my_top_pick_ids.each do |pid| %>
        <input type="hidden" name="pair_ids[]" value="<%= pid %>">
      <% end %>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-8 mb-6">
      <% all_pairs.each do |pair| %>
        <% is_picked = my_top_pick_ids.include?(pair.id) %>
        <% pick_position = top_pick_positions[pair.id] %>
        <div class="group cursor-pointer transition-all select-none"
             data-top-picks-target="card"
             data-pair-id="<%= pair.id %>"
             data-preselected="<%= is_picked %>"
             data-preselected-position="<%= pick_position || 0 %>"
             data-action="click->top-picks#toggle">

          <div class="relative aspect-video bg-[#e5e5e5] rounded-xl overflow-hidden mb-3">
            <% if pair.has_thumbnail? %>
              <% if pair.thumbnail.attached? %>
                <%= image_tag pair.thumbnail, class: "w-full h-full object-cover", loading: "lazy" %>
              <% else %>
                <img src="<%= pair.thumbnail_url %>" class="w-full h-full object-cover" alt="" loading="lazy">
              <% end %>
            <% else %>
              <div class="w-full h-full flex items-center justify-center text-[#909090]">
                <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M21 3H3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h18c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 16H3V5h18v14zM9.5 13l2.5 3.01L14.5 12l4.5 6H5l4.5-6z"/>
                </svg>
              </div>
            <% end %>

            <% if @video.video_duration.present? %>
              <span class="absolute bottom-1 right-1 bg-black/80 text-white font-medium px-1 rounded z-10" style="font-size: 11px; line-height: 16px; letter-spacing: 0.5px;"><%= @video.video_duration %></span>
            <% end %>

            <!-- Rank badge -->
            <div data-checkmark class="absolute top-2 left-2 bg-[#065fd4] text-white text-sm font-bold w-8 h-8 rounded-full flex items-center justify-center z-10 shadow <%= 'hidden' unless is_picked %>">
              <span data-rank-label><%= is_picked ? "##{pick_position}" : "" %></span>
            </div>

            <!-- Hover overlay -->
            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/30 transition-all flex items-center justify-center opacity-0 group-hover:opacity-100 pointer-events-none">
              <span class="bg-white/95 backdrop-blur-sm text-[#0f0f0f] text-xs font-medium px-3 py-1.5 rounded-full shadow-sm">Click to select</span>
            </div>

            <!-- Blue tint overlay when selected -->
            <div data-overlay class="absolute inset-0 bg-[#065fd4]/10 pointer-events-none <%= 'hidden' unless is_picked %>"></div>
          </div>

          <div class="flex gap-3">
            <% if @admin.avatar_url %>
              <img src="<%= @admin.avatar_url %>" class="w-9 h-9 rounded-full flex-shrink-0 mt-1" alt="" referrerpolicy="no-referrer">
            <% else %>
              <div class="w-9 h-9 rounded-full bg-[#ef4444] flex items-center justify-center text-white text-sm font-medium flex-shrink-0 mt-1">
                <%= @admin.yt_username[0].upcase %>
              </div>
            <% end %>
            <div class="flex-1 min-w-0">
              <h3 class="text-[#0f0f0f] line-clamp-2 mb-1" style="font-size: 14px; font-weight: 500; line-height: 20px;"><%= pair.title %></h3>
              <p class="text-[#606060]" style="font-size: 12px; line-height: 18px;"><%= @admin.yt_username %></p>
              <p class="text-[#606060]" style="font-size: 12px; line-height: 18px;"><%= @video.sample_views %> &middot; 1 hour ago</p>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <div class="flex items-center justify-between">
      <%= link_to preview_path(@video.share_token, @video_share.token, step: 2, vi: @variants.size - 1), class: "inline-flex items-center gap-2 text-sm font-medium text-[#606060] hover:text-[#0f0f0f] transition" do %>
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
        Back
      <% end %>

      <div class="flex items-center gap-3">
        <span class="text-xs font-medium px-2.5 py-1 rounded-full bg-[#e5e5e5] text-[#606060]" data-top-picks-target="counter">
          <%= my_top_pick_ids.size %>/3 ranked
        </span>
        <button type="submit" data-top-picks-target="submitBtn"
                class="inline-flex items-center gap-2 bg-[#065fd4] text-white text-sm font-medium px-6 py-2.5 rounded-full transition
                       <%= my_top_pick_ids.size == 3 ? 'hover:bg-[#0051b5] cursor-pointer' : 'opacity-50 cursor-not-allowed' %>"
                <%= 'disabled' unless my_top_pick_ids.size == 3 %>>
          Next: Feedback
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
        </button>
      </div>
    </div>
  <% end %>
</div>
