<!-- Step 1: Rank all variants -->
<%
  variant_vote_positions = {}
  @my_variant_votes.each { |vv| variant_vote_positions[vv.variant_id] = vv.position }
  all_variants_ranked = @my_variant_votes.size == @variants.size
%>

<div class="mb-6">
  <h1 class="text-xl font-bold text-[#0f0f0f] mb-1">Step 1: Rank the variants</h1>
  <p class="text-sm text-[#606060]">Click each variant in order of preference. First click = #1, second = #2, and so on.</p>
</div>

<div data-controller="variant-rank"
     data-variant-rank-total-value="<%= @variants.size %>"
     data-variant-rank-url-value="<%= vote_variant_path(@video.share_token, @video_share.token) %>"
     data-variant-rank-token-value="<%= form_authenticity_token %>">

  <% @variants.each do |variant| %>
    <% vv_position = variant_vote_positions[variant.id] %>
    <div class="mb-10"
         data-variant-rank-target="variant"
         data-variant-id="<%= variant.id %>"
         data-preselected-position="<%= vv_position || 0 %>">

      <!-- Variant header -->
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
          <h2 class="text-lg font-medium text-[#0f0f0f]"><%= variant.name %></h2>
          <span data-rank-badge
                class="inline-flex items-center justify-center w-8 h-8 rounded-full text-sm font-bold cursor-pointer transition-all
                       <%= vv_position ? 'bg-[#065fd4] text-white' : 'hidden bg-[#e5e5e5] text-[#606060]' %>"
                data-action="click->variant-rank#toggle">
            <%= vv_position ? "##{vv_position}" : "—" %>
          </span>
        </div>
        <button type="button"
                class="inline-flex items-center gap-1.5 text-sm font-medium bg-[#065fd4] text-white hover:bg-[#0051b5] px-3 py-1.5 rounded-full transition cursor-pointer"
                data-action="click->variant-rank#toggle">
          <% if vv_position %>
            #<%= vv_position %> — click to change
          <% else %>
            Click to rank
          <% end %>
        </button>
      </div>

      <!-- YouTube-style card grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-8">
        <% variant.title_thumbnail_pairs.each do |pair| %>
          <div class="group">
            <div class="relative aspect-video bg-[#e5e5e5] rounded-xl overflow-hidden mb-3">
              <% if pair.has_thumbnail? %>
                <% if pair.thumbnail.attached? %>
                  <%= image_tag pair.thumbnail, class: "w-full h-full object-cover", loading: "lazy" %>
                <% else %>
                  <img src="<%= pair.thumbnail_url %>" class="w-full h-full object-cover" alt="" loading="lazy">
                <% end %>
              <% else %>
                <div class="w-full h-full flex items-center justify-center text-[#909090]">
                  <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M21 3H3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h18c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 16H3V5h18v14zM9.5 13l2.5 3.01L14.5 12l4.5 6H5l4.5-6z"/>
                  </svg>
                </div>
              <% end %>
              <% if @video.video_duration.present? %>
                <span class="absolute bottom-1 right-1 bg-black/80 text-white font-medium px-1 rounded z-10" style="font-size: 11px; line-height: 16px; letter-spacing: 0.5px;"><%= @video.video_duration %></span>
              <% end %>
            </div>
            <div class="flex gap-3">
              <% if @admin.avatar_url %>
                <img src="<%= @admin.avatar_url %>" class="w-9 h-9 rounded-full flex-shrink-0 mt-1" alt="" referrerpolicy="no-referrer">
              <% else %>
                <div class="w-9 h-9 rounded-full bg-[#ef4444] flex items-center justify-center text-white text-sm font-medium flex-shrink-0 mt-1">
                  <%= @admin.yt_username[0].upcase %>
                </div>
              <% end %>
              <div class="flex-1 min-w-0">
                <h3 class="text-[#0f0f0f] line-clamp-2 mb-1" style="font-size: 14px; font-weight: 500; line-height: 20px;"><%= pair.title %></h3>
                <p class="text-[#606060]" style="font-size: 12px; line-height: 18px;"><%= @admin.yt_username %></p>
                <p class="text-[#606060]" style="font-size: 12px; line-height: 18px;"><%= @video.sample_views %> &middot; 1 hour ago</p>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Next button submits variant ranking -->
  <div class="flex justify-end">
    <button type="button"
            data-variant-rank-target="submitBtn"
            data-action="click->variant-rank#submit"
            class="inline-flex items-center gap-2 bg-[#065fd4] text-white text-sm font-medium px-6 py-2.5 rounded-full transition
                   <%= all_variants_ranked ? 'hover:bg-[#0051b5] cursor-pointer' : 'opacity-50 cursor-not-allowed' %>"
            <%= 'disabled' unless all_variants_ranked %>>
      Next: Pick favorites
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
    </button>
  </div>
</div>
