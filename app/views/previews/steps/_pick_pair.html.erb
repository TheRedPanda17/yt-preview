<!-- Step 2: Pick favorite pair for one variant at a time -->
<%
  variant = @variants[@variant_index]
  is_last_variant = @variant_index == @variants.size - 1
  existing_pair_vote = variant.pair_votes.detect { |v| v.voter_name == voter_name }
%>

<div class="mb-6">
  <h1 class="text-xl font-bold text-[#0f0f0f] mb-1">
    Step 2: Pick the best thumbnail
    <span class="text-[#606060] font-normal">(<%= @variant_index + 1 %> of <%= @variants.size %>)</span>
  </h1>
  <p class="text-sm text-[#606060]">Which thumbnail works best for <strong><%= variant.name %></strong>? Click the one you like most.</p>
</div>

<div class="mb-10">
  <!-- Variant name header -->
  <div class="flex items-center gap-3 mb-4">
    <h2 class="text-lg font-medium text-[#0f0f0f]"><%= variant.name %></h2>
    <% rank_position = @my_variant_votes.detect { |vv| vv.variant_id == variant.id }&.position %>
    <% if rank_position %>
      <span class="inline-flex items-center justify-center w-8 h-8 rounded-full text-sm font-bold bg-[#065fd4] text-white">
        #<%= rank_position %>
      </span>
    <% end %>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-8">
    <% variant.title_thumbnail_pairs.each do |pair| %>
      <% is_voted = existing_pair_vote&.title_thumbnail_pair_id == pair.id %>

      <div class="group">
        <div class="relative aspect-video bg-[#e5e5e5] rounded-xl overflow-hidden mb-3 cursor-pointer">
          <% if pair.has_thumbnail? %>
            <% if pair.thumbnail.attached? %>
              <%= image_tag pair.thumbnail, class: "w-full h-full object-cover", loading: "lazy" %>
            <% else %>
              <img src="<%= pair.thumbnail_url %>" class="w-full h-full object-cover" alt="" loading="lazy">
            <% end %>
          <% else %>
            <div class="w-full h-full flex items-center justify-center text-[#909090]">
              <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 24 24">
                <path d="M21 3H3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h18c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 16H3V5h18v14zM9.5 13l2.5 3.01L14.5 12l4.5 6H5l4.5-6z"/>
              </svg>
            </div>
          <% end %>

          <% if @video.video_duration.present? %>
            <span class="absolute bottom-1 right-1 bg-black/80 text-white font-medium px-1 rounded z-10" style="font-size: 11px; line-height: 16px; letter-spacing: 0.5px;"><%= @video.video_duration %></span>
          <% end %>

          <% if is_voted %>
            <div class="absolute top-2 left-2 bg-[#065fd4] text-white text-xs font-medium px-2.5 py-1 rounded-full flex items-center gap-1 z-10">
              <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
              Your pick
            </div>
            <div class="absolute inset-0 bg-[#065fd4]/10 pointer-events-none"></div>
          <% else %>
            <%= button_to vote_pair_path(@video.share_token, @video_share.token, variant_id: variant.id, pair_id: pair.id, vi: @variant_index), method: :post, class: "absolute inset-0 bg-black/0 group-hover:bg-black/30 transition-all flex items-center justify-center opacity-0 group-hover:opacity-100 cursor-pointer" do %>
              <span class="bg-white/95 backdrop-blur-sm text-[#0f0f0f] text-xs font-medium px-3 py-1.5 rounded-full shadow-sm">
                Pick this one
              </span>
            <% end %>
          <% end %>
        </div>

        <div class="flex gap-3">
          <% if @admin.avatar_url %>
            <img src="<%= @admin.avatar_url %>" class="w-9 h-9 rounded-full flex-shrink-0 mt-1" alt="" referrerpolicy="no-referrer">
          <% else %>
            <div class="w-9 h-9 rounded-full bg-[#ef4444] flex items-center justify-center text-white text-sm font-medium flex-shrink-0 mt-1">
              <%= @admin.yt_username[0].upcase %>
            </div>
          <% end %>
          <div class="flex-1 min-w-0">
            <h3 class="text-[#0f0f0f] line-clamp-2 mb-1" style="font-size: 14px; font-weight: 500; line-height: 20px;"><%= pair.title %></h3>
            <p class="text-[#606060]" style="font-size: 12px; line-height: 18px;"><%= @admin.yt_username %></p>
            <p class="text-[#606060]" style="font-size: 12px; line-height: 18px;"><%= @video.sample_views %> &middot; 1 hour ago</p>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>

<div class="flex items-center justify-between">
  <% if @variant_index > 0 %>
    <%= link_to preview_path(@video.share_token, @video_share.token, step: 2, vi: @variant_index - 1), class: "inline-flex items-center gap-2 text-sm font-medium text-[#606060] hover:text-[#0f0f0f] transition" do %>
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
      Previous variant
    <% end %>
  <% else %>
    <%= link_to preview_path(@video.share_token, @video_share.token, step: 1), class: "inline-flex items-center gap-2 text-sm font-medium text-[#606060] hover:text-[#0f0f0f] transition" do %>
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
      Back to ranking
    <% end %>
  <% end %>

  <% if existing_pair_vote %>
    <% if is_last_variant %>
      <%= link_to preview_path(@video.share_token, @video_share.token, step: 3), class: "inline-flex items-center gap-2 bg-[#065fd4] text-white text-sm font-medium px-6 py-2.5 rounded-full hover:bg-[#0051b5] transition cursor-pointer" do %>
        Next: Top 3
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
      <% end %>
    <% else %>
      <%= link_to preview_path(@video.share_token, @video_share.token, step: 2, vi: @variant_index + 1), class: "inline-flex items-center gap-2 bg-[#065fd4] text-white text-sm font-medium px-6 py-2.5 rounded-full hover:bg-[#0051b5] transition cursor-pointer" do %>
        Next variant
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
      <% end %>
    <% end %>
  <% else %>
    <span class="text-xs text-[#909090]">Pick a thumbnail above to continue</span>
  <% end %>
</div>
